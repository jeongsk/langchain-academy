<%*
// aiProvider 설정
// Note: AI Providers 플러그인에서 provider를 미리 설정해야 합니다
// AI Providers: <https://obsidian.md/plugins?id=ai-providers>
const PROVIDER_NAME = "ollama:gpt-oss"; // AI Providers 플러그인에서 설정한 provider 이름

// 현재 파일 정보 가져오기
const currentFile = tp.file.find_tfile(tp.file.title);
if (!currentFile) {
    new Notice("현재 파일을 찾을 수 없습니다.");
    return;
}

// 볼트의 폴더 구조 가져오기 (TFolder 클래스 사용하지 않음)
const allFiles = app.vault.getAllLoadedFiles();
const allFolders = allFiles
    .filter(f => f.children !== undefined) // 폴더는 children 속성을 가짐
    .map(f => f.path)
    .filter(path => path !== "" && path !== "/")
    .sort();

// 폴더 구조를 문자열로 변환
const folderStructure = allFolders.join("\n");

// 노트 내용 가져오기
const fileContent = tp.file.content;
const fileName = tp.file.title;

// 폴더 추천 프롬프트
const systemPrompt = `당신은 **Obsidian 노트 관리 전문가**로서, 노트의 내용과 제목을 분석하여 가장 적절한 폴더를 추천하는 역할을 수행합니다.

다음 정보를 바탕으로 분석해주세요:

1. **파일명**: ${fileName}
2. **사용 가능한 폴더 목록**:
${folderStructure}

3. **파일 내용**: (아래 제공)

분석 기준:

- 노트의 주제와 내용 유형
- 파일명의 패턴이나 키워드
- 문서의 목적 (일기, 회의록, 프로젝트, 아이디어, 참고자료 등)
- 기존 폴더 구조와의 일관성

응답 형식:
반드시 다음 JSON 형태로만 응답해주세요:
{
  "recommended_folder": "추천하는 정확한 폴더 경로",
  "confidence": "높음/보통/낮음",
  "reason": "추천 이유를 한 문장으로 설명",
  "alternative_folders": ["대안 폴더1", "대안 폴더2"]
}

중요: 추천하는 폴더는 반드시 위의 사용 가능한 폴더 목록에 있는 것이어야 합니다. 존재하지 않는 폴더를 추천하지 마세요.`;

try {
    // AI에게 폴더 추천 요청 (aiProvider 사용)
    const provider = app.aiProviders.providers.find(e => e.name === PROVIDER_NAME);
    const messages = [
  { role: "system", content: systemPrompt },
  { role: "user", content: `파일 내용:\n${fileContent}` }
 ];
    const aiResponse = await app.aiProviders.execute({ provider, messages, onProgress: (_chunk, text) => text });

    // JSON 파싱
    let recommendation;
    try {
        // AI 응답에서 JSON 부분만 추출 (마크다운 코드 블록 제거)
        const cleanResponse = aiResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        const jsonString = jsonMatch ? jsonMatch[0] : cleanResponse;
        recommendation = JSON.parse(jsonString);
    } catch (parseError) {
        new Notice("AI 응답을 파싱하는 중 오류가 발생했습니다.");
        console.error('Parse Error:', parseError);
        return;
    } finally {
        console.log('AI Response:', aiResponse);
    }

    // 추천 결과 표시 및 사용자 선택
    const options = [
        `✅ 추천: ${recommendation.recommended_folder} (${recommendation.confidence})`,
        ...recommendation.alternative_folders.map(folder => `📁 대안: ${folder}`),
        "🔍 다른 폴더 선택",
        "❌ 취소"
    ];

    const values = [
        recommendation.recommended_folder,
        ...recommendation.alternative_folders,
        "manual_select",
        "cancel"
    ];

    const selectedOption = await tp.system.suggester(
        options,
        values,
        false,
        `폴더 추천 결과:\n${recommendation.reason}\n\n이동할 폴더를 선택하세요:`
    );

    let targetFolder = null;

    if (selectedOption === "manual_select") {
        // 수동 폴더 선택
        targetFolder = await tp.system.suggester(
            allFolders.map(f => f || "Root"),
            allFolders,
            false,
            "수동으로 폴더를 선택하세요:"
        );
    } else if (selectedOption !== "cancel" && selectedOption !== undefined) {
        targetFolder = selectedOption;
    }

    // 파일 이동 실행
    if (targetFolder) {
        // 대상 폴더 존재 확인
        const folderExists = app.vault.getAbstractFileByPath(targetFolder);
        if (!folderExists) {
            new Notice(`폴더 "${targetFolder}"가 존재하지 않습니다.`);
            return;
        }

        try {
            const newPath = `${targetFolder}/${currentFile.name}`;
            await app.fileManager.renameFile(currentFile, newPath);
            
            new Notice(`✅ 노트가 "${targetFolder}" 폴더로 이동되었습니다!\n이유: ${recommendation.reason}`);
            
            // 이동 로그를 콘솔에 기록
            console.log(`File moved: ${currentFile.path} → ${newPath}`);
            console.log(`Recommendation confidence: ${recommendation.confidence}`);
            
        } catch (error) {
            new Notice(`❌ 이동 중 오류가 발생했습니다: ${error.message}`);
            console.error('Move Error:', error);
        }
    } else {
        new Notice("이동이 취소되었습니다.");
    }

} catch (error) {
    new Notice(`❌ AI 분석 중 오류가 발생했습니다: ${error.message}`);
    console.error('AI Analysis Error:', error);

    // 오류 발생 시 수동 폴더 선택으로 폴백
    const fallbackFolder = await tp.system.suggester(
        ["AI 분석 실패 - 수동으로 폴더를 선택하세요:", ...allFolders],
        [null, ...allFolders],
        false,
        "오류가 발생했습니다. 수동으로 폴더를 선택하시겠습니까?"
    );
    
    if (fallbackFolder) {
        try {
            const newPath = `${fallbackFolder}/${currentFile.name}`;
            await app.fileManager.renameFile(currentFile, newPath);
            new Notice(`노트가 "${fallbackFolder}" 폴더로 이동되었습니다. (수동 선택)`);
        } catch (moveError) {
            new Notice(`이동 중 오류가 발생했습니다: ${moveError.message}`);
        }
    }
}
%>
